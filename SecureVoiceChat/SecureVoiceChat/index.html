 <!--Megan Smith
     Network Security
     Fall 2015 -->
<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
   
    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }
    </style>
</head>
<body>
  
    <div class="container">
        <input type="hidden" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <input type="button" id="authentication" value="Begin Authentication of User" />
        <input type="hidden" id="displayname" />
        <input type="hidden" id="array" />
        <input type="hidden" id="arrayLength" />
        <input type="hidden" id="OriginalNonce" />
        <input type="hidden" id="encryptedNonce" />
        <input hidden type="button" id="authenticationEncryptNonce" value="Encrypt Nonce" />
        <input hidden type="button" id="authenticationVerifyNonce" value="Verify Nonce" />
        <ul id="discussion"></ul>
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <p id=" printName">SignalR Chat</p>
    <p>Live input record and playback</p>
    <style type='text/css'>
        ul {
            list-style: none;
        }

        #recordingslist audio {
            display: block;
            margin-bottom: 10px;
        }
    </style>

    <h1>WAV Export</h1>


    <button onclick="startRecording(this);">record</button>
    <button onclick="stopRecording(this);" disabled>stop</button>
    <h2>Decrypted Recordings</h2>
    <ul id="decryptedrecordingslist"></ul>

    <h2>Recordings</h2>
    <ul id="recordingslist"></ul>

    <h2>Log</h2>
    <pre id="log"></pre>
    <script type="text/javascript">
        var key = prompt("Enter shared secret key: ");
        
       
        var sentArray = "";
        $(function () {
            var sentArray = "";
            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;
         
            // Create a function that the hub can call to broadcast messages.
            chat.client.broadcastAuthentication = function (name, message, nonce) {
                document.getElementById("OriginalNonce").value = nonce;
                var encodedNameAuth = $('<div />').text(name).html();
                var encodedMessageAuth = $('<div />').text(message).html();
                $('#discussion').append('<li><strong>' + encodedNameAuth
                            + '</strong>:&nbsp;&nbsp;' + encodedMessageAuth + '</li>'
                         
        );
                $('#authenticationEncryptNonce').show();

            };
            chat.client.broadcastAuthenticationEncryptNonce = function (name, message, nonce) {
          
                document.getElementById("encryptedNonce").value = nonce;
                var encodedNameAuth = $('<div />').text(name).html();
                var encodedMessageAuth = $('<div />').text(message).html();
                $('#discussion').append('<li><strong>' + encodedNameAuth
                            + '</strong>:&nbsp;&nbsp;' + encodedMessageAuth + '</li>'
                     );
                
                $('#authenticationVerifyNonce').show();
            };
            chat.client.broadcastAuthenticationConfirmation = function (name, message) {
               
                var encodedNameAuth = $('<div />').text(name).html();
                var encodedMessageAuth = $('<div />').text(message).html();
                $('#discussion').append('<li><strong>' + encodedNameAuth
                            + '</strong>:&nbsp;&nbsp;' + encodedMessageAuth + '</li>');
            };
            chat.client.broadcastAuthenticationFailure = function (name, message) {
               
                var encodedNameAuth = $('<div />').text(name).html();
                var encodedMessageAuth = $('<div />').text(message).html();
                $('#discussion').append('<li><strong>' + encodedNameAuth
                            + '</strong>:&nbsp;&nbsp;' + encodedMessageAuth + '</li>');
                $.connection.hub.stop();
                alert("Connection Severed");
            };
            chat.client.broadcastMessage = function (name, message) {
                
                sentArray = sentArray.concat(message);

            };
            chat.client.broadcastAudio = function (name, message) {


                var encodedName = $('<div />').text(name).html();
                $('#discussion').append('<li><strong>' + encodedName
                            + '</strong></li>');
                   
                sentArray = sentArray.replace(/\s/g, '');
                var sentArray2 = sentArray.split(",");
                var byteDataArray = new Uint8Array(sentArray2.length);
                for (var i = 0; i < byteDataArray.length; i++) {
                    byteDataArray[i] = sentArray2[i];
                }
                discussion.appendChild(decode(byteDataArray));
                var decodedAudio = rc4(key, byteDataArray);
                decryptedrecordingslist.appendChild(decode(decodedAudio));
                sentArray = "";

            };
            // Get the user name and store it to prepend to messages.
            $('#displayname').val(prompt('Enter your name:', ''));
            document.getElementById(" printName").innerHTML = $('#displayname').val()+"'s chat window!";
  
            // Start the connection.

            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    
                    var sentArray = "";
                    $('#message').val('');
                    for ( var i = 0, j = 10000; j < 2000000; i = i + 10000, j = j + 10000) {
                        document.getElementById("message").value = $('#array').val().slice(i, j);
                        chat.server.send($('#displayname').val(), $('#message').val());
                    }
                   
                    alert("converting"); 
                  
                    chat.server.sendAudio($('#displayname').val(), "here");
                });

            });
            $.connection.hub.start().done(function () {
                $('#authentication').click(function () {
                    var newNonce = createNonce();
                    document.getElementById("OriginalNonce").value = newNonce;
                    alert("Sent nonce: " + newNonce);
                    chat.server.sendAuth($('#displayname').val(), "Hello, I am " + $('#displayname').val()+". Please encrypt the nonce I sent you.", newNonce);
                    
              
                });

            });
    
            $.connection.hub.start().done(function () {
                $('#authenticationEncryptNonce').click(function () {
                    
                    var nonce = $('#OriginalNonce').val();
                    var randomByteArray = new Uint8Array(nonce.length);
                  
                for (var i = 0; i < randomByteArray.length; i++) {
                    randomByteArray[i] = nonce.charAt(i);
                  
                }

                var byteArrayNonce = new Uint8Array(rc4Authenticate(key, randomByteArray));
                var nonceStr = "";
                var alertStr = "";
                for (var i = 0; i < byteArrayNonce.length; i++) {
                    alertStr = alertStr + byteArrayNonce[i];
                }
                alert("Sent encrypted nonce: " + alertStr);
                for(var i = 0; i<byteArrayNonce.length;i++){
                    nonceStr = nonceStr+ byteArrayNonce[i]+",";
                }
                document.getElementById("encryptedNonce").value = nonceStr;
               
                chat.server.sendAuthenticationEncryptNonce($('#displayname').val(), "Hello, I am " + $('#displayname').val()+". Please verify the encrypted nonce I sent you.",nonceStr );
                  });

            });

            $.connection.hub.start().done(function () {
                $('#authenticationVerifyNonce').click(function () {
                    var nonce = $('#encryptedNonce').val();
                    nonce = nonce.split(",");

                var randomByteArray = new Uint8Array(nonce.length-1);
                for (var i = 0; i < randomByteArray.length; i++) {
                    randomByteArray[i] = nonce[i];
                }
                var byteArrayNonce = new Uint8Array(rc4Authenticate(key, randomByteArray));
                var nonceStr = "";
                for (var i = 0; i < byteArrayNonce.length; i++) {
                    nonceStr = nonceStr+ byteArrayNonce[i];
                }
                if (nonceStr == $('#OriginalNonce').val()) {
                        alert("Successfully decrypted nonce: " + nonceStr);
                        chat.server.sendAuthenticationConfirmation($('#displayname').val(), "User is authenticated");
            }
                if (nonceStr != $('#OriginalNonce').val()) {
                        alert("Unuccessfully decrypted nonce: " + nonceStr);
                        chat.server.sendAuthenticationFailure($('#displayname').val(), "User is not authenticated");
                }
                $('#OriginalNonce').val() = "";
                $('#encryptedNonce').val() = "";
                  });

            });
           
        });


  function __log(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }
  var audio_context;
  var recorder;
  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
    __log('Media stream created.');
    // Uncomment if you want the audio to feedback directly
    //input.connect(audio_context.destination);
    //__log('Input connected to audio context destination.');

    recorder = new Recorder(input);
    __log('Recorder initialised.');
  }
  function startRecording(button) {

    recorder && recorder.record();
    button.disabled = true;
    button.nextElementSibling.disabled = false;
    __log('Recording...');
  }
  function stopRecording(button) {
    recorder && recorder.stop();
    button.disabled = true;
    button.previousElementSibling.disabled = false;
    __log('Stopped recording.');

    // create WAV download link using audio data blob
    createDownloadLink();

    recorder.clear();
  }
  function createDownloadLink() {
    recorder && recorder.exportWAV(function(blob) {
        var url = URL.createObjectURL(blob);
  
      var li = document.createElement('li');
      var au = document.createElement('audio');
      var hf = document.createElement('a');

      au.controls = true;
      au.src = url;
      hf.href = url;
      hf.download = new Date().toISOString() + '.wav';
      hf.innerHTML = hf.download;
      li.appendChild(au);
      li.appendChild(hf);
      recordingslist.appendChild(li);

      convert(blob);

    });
  }
  function convert(blob) {

      var reader = new FileReader();
      reader.readAsArrayBuffer(blob);
      reader.onload = function () {
      var generatedBuffer = reader.result;
      encode(generatedBuffer);
      deferred.resolve();

      };


  }
  function encode(buffer) {
      var byteArray = new Uint8Array(buffer);
      var encodedAudio = rc4(key, byteArray);
      $('#array').val('');
      document.getElementById("array").value = encodedAudio;
      document.getElementById("arrayLength").value = encodedAudio.length;
  }

  function rc4(key, byteArray) {
      var stream = new Uint8Array(256);
    
      var encodedByteArray = byteArray;
      for (var i = 0; i < stream.length; i++) {
          stream[i] = i;
      }
      var j = 0;
      var x = 0;
      for (i = 0; i < stream.length; i++) {
          j = (j + stream[i] + key.charCodeAt(i % key.length)) % 256;
          x = stream[i];
          stream[i] = stream[j];
          stream[j] = x;
      }

      i = 0;
      j = 0;
      for (var y = 44; y < byteArray.length; y++) {
          var temp = encodedByteArray[y];
          i = (i + 1) % 256;
          j = (j + stream[i]) % 256;
          x = stream[i];
          stream[i] = stream[j];
          stream[j] = x;

          encodedByteArray[y] = stream[(stream[i] + stream[j]) % 256] ^ temp;
      }

      return encodedByteArray;
  }
  function rc4Authenticate(key, byteArray) {
      var stream = new Uint8Array(256);

      var encodedByteArray = byteArray;
      for (var i = 0; i < stream.length; i++) {
          stream[i] = i;
      }
      var j = 0;
      var x = 0;
      for (i = 0; i < stream.length; i++) {
          j = (j + stream[i] + key.charCodeAt(i % key.length)) % 256;
          x = stream[i];
          stream[i] = stream[j];
          stream[j] = x;
      }

      i = 0;
      j = 0;
      for (var y = 0; y < byteArray.length; y++) {
          var temp = encodedByteArray[y];
          i = (i + 1) % 256;
          j = (j + stream[i]) % 256;
          x = stream[i];
          stream[i] = stream[j];
          stream[j] = x;

          encodedByteArray[y] = stream[(stream[i] + stream[j]) % 256] ^ temp;
      }

      return encodedByteArray;
  }


  function decode(byteArray) {

      var arrayBuffer = byteArray.buffer;
      var li2 = read(arrayBuffer);
      return (li2);
  }


  function read(file) {
          var blob = new Blob([file], { type: 'audio/wav' });
          var url2 = URL.createObjectURL(blob);
          var li2 = document.createElement('li');
          var au2 = document.createElement('audio');
          var hf2 = document.createElement('a');
         
          au2.controls = true;
          au2.src = url2;
          hf2.href = url2;
          hf2.download = new Date().toISOString() + '.wav';
          hf2.innerHTML = hf2.download;
          li2.appendChild(au2);
          li2.appendChild(hf2);
          return (li2);
  }

  function createNonce() {
      var text = "";
      var possible = "0123456789";

      for (var i = 0; i < 20; i++)
          text += possible.charAt(Math.floor(Math.random() * possible.length));

      return text;
  }

  window.onload = function init() {
    try {
      // webkit shim
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
      window.URL = window.URL || window.webkitURL;

      audio_context = new AudioContext;
      __log('Audio context set up.');
      __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
    } catch (e) {
      alert('No web audio support in this browser!');
    }

    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      __log('No live audio input: ' + e);
    });
  };
        </script>

        <script src="recorder.js"></script>
    </body>
</html>






